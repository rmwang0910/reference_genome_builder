# 参考基因组构建智能体架构文档

## 概述

本智能体采用分层架构设计，结合LLM（大语言模型）和基于规则的决策系统，实现智能化的参考基因组下载和索引构建。

## 架构设计

### 1. 核心组件

```
┌─────────────────────────────────────────────────────────┐
│                  ReferenceGenomeAgent                    │
│                  (智能体核心)                           │
├─────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │   LLM模块    │  │  状态管理    │  │  工具注册     │ │
│  │  (决策规划)  │  │  (任务跟踪)  │  │  (功能调用)   │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────┘
         │                    │                    │
         ▼                    ▼                    ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  下载模块    │  │  索引构建    │  │  错误恢复    │
│ (download.py)│  │(index_builder)│  │  (重试机制)   │
└──────────────┘  └──────────────┘  └──────────────┘
```

### 2. 智能体特性

#### 2.1 自主决策能力

智能体能够根据用户需求自动做出决策：

- **数据源选择**：根据用户需求和使用场景，智能推荐最佳数据源（NCBI RefSeq/Ensembl/UCSC）
- **工具选择**：根据分析类型（WGS/RNA-seq/长读长）自动选择最佳索引工具
- **参数优化**：自动设置最佳参数（线程数、SJDB overhang等）

**实现方式**：
- **LLM模式**：使用大语言模型理解用户意图，生成任务规划
- **规则模式**：基于关键词匹配和规则库进行决策（LLM不可用时的降级方案）

#### 2.2 任务规划能力

智能体能够将用户需求分解为可执行的任务序列：

```python
用户请求: "我需要为RNA-seq分析准备人类参考基因组和STAR索引"

规划结果:
1. task_1: 下载参考基因组 (download)
2. task_2: 解压缩文件 (decompress)
3. task_3: 构建STAR索引 (build_index)
```

**实现方式**：
- LLM生成结构化任务计划（JSON格式）
- 支持任务间依赖关系（使用 `{{task_X.result}}` 引用）

#### 2.3 状态管理

智能体维护完整的任务状态：

```python
AgentState:
  - current_task: 当前执行的任务
  - tasks: 所有任务列表
  - context: 上下文信息
  - history: 执行历史
```

**状态持久化**：
- 自动保存到 `agent_state.json`
- 支持任务恢复和断点续传

#### 2.4 错误恢复机制

智能体具备自动错误恢复能力：

- **自动重试**：任务失败时自动重试（最多3次）
- **降级策略**：如果某个数据源失败，自动尝试其他数据源
- **错误记录**：详细记录错误信息，便于诊断

#### 2.5 工具调用能力

智能体通过工具注册机制动态调用功能：

```python
tools = {
    'download': download_tool,
    'decompress': decompress_tool,
    'build_index': build_index_tool
}
```

**特点**：
- 工具可扩展：易于添加新工具
- 参数解析：自动解析任务参数
- 结果传递：支持任务间结果传递

### 3. 工作流程

```
用户请求
    │
    ▼
┌─────────────────┐
│  任务规划       │ ← LLM或规则引擎
└─────────────────┘
    │
    ▼
┌─────────────────┐
│  任务执行       │ ← 工具调用
└─────────────────┘
    │
    ▼
┌─────────────────┐
│  状态更新       │ ← 状态管理
└─────────────────┘
    │
    ▼
┌─────────────────┐
│  结果返回       │
└─────────────────┘
```

### 4. LLM集成

#### 4.1 LLM的作用

1. **任务规划**：理解用户自然语言请求，生成结构化任务计划
2. **智能推荐**：根据使用场景推荐最佳方案
3. **参数优化**：根据具体情况优化参数设置

#### 4.2 Prompt设计

**任务规划Prompt**：
```
你是一个参考基因组构建专家。根据用户的需求，规划出需要执行的任务步骤。

用户需求: {user_request}

可用的工具：
1. download - 下载参考基因组
2. decompress - 解压缩文件
3. build_index - 构建索引

请分析用户需求，规划出详细的任务步骤...
```

**推荐Prompt**：
```
你是一个生物信息学专家。根据用户的使用场景，推荐最佳的参考基因组数据源和索引工具。

使用场景: {use_case}

请推荐：
1. 最佳数据源及理由
2. 最佳索引工具及理由
3. 推荐的参数设置
```

#### 4.3 降级机制

如果LLM不可用或调用失败，自动降级到基于规则的决策：

```python
if self.use_llm:
    return self._plan_with_llm(user_request)
else:
    return self._plan_with_rules(user_request)
```

### 5. 与传统工具的区别

| 特性 | 传统工具 | 智能体 |
|------|---------|--------|
| 交互方式 | 命令行参数 | 自然语言 |
| 决策能力 | 用户指定 | 自动决策 |
| 任务规划 | 手动步骤 | 自动规划 |
| 错误处理 | 手动重试 | 自动恢复 |
| 推荐功能 | 无 | 智能推荐 |
| 状态管理 | 无 | 完整状态跟踪 |

### 6. 使用示例

#### 6.1 自然语言交互

```bash
# 智能体模式
python agent_main.py "我需要为RNA-seq分析准备人类参考基因组和STAR索引"
```

智能体会自动：
1. 理解这是RNA-seq分析场景
2. 推荐使用Ensembl数据源和STAR工具
3. 规划下载→解压缩→构建索引的步骤
4. 自动执行所有任务

#### 6.2 获取推荐

```bash
python agent_main.py --recommend "WGS全基因组测序分析"
```

输出：
```
推荐方案:
  数据源: ncbi_refseq
  理由: NCBI RefSeq是官方参考序列数据库，最常用
  索引工具: bwa
  理由: BWA是短读长序列比对的标准工具
  参数: {'threads': 8}
```

### 7. 扩展性

#### 7.1 添加新工具

```python
def new_tool(param1: str, param2: int):
    # 工具实现
    return result

# 注册工具
agent.tools['new_tool'] = new_tool
```

#### 7.2 添加新决策规则

在 `_plan_with_rules` 或 `_recommend_with_rules` 中添加新的规则逻辑。

#### 7.3 自定义LLM Prompt

修改 `_plan_with_llm` 或 `_recommend_with_llm` 中的prompt模板。

### 8. 配置文件

智能体支持配置文件（可选）：

```yaml
agent:
  use_llm: true
  max_retries: 3
  auto_recovery: true
  
llm:
  model: "qwen-plus"
  temperature: 0.3
  max_tokens: 2000
```

### 9. 最佳实践

1. **启用LLM**：对于复杂需求，启用LLM获得更好的决策
2. **状态保存**：定期检查 `agent_state.json` 了解执行状态
3. **错误处理**：查看日志了解任务失败原因
4. **参数调优**：根据实际情况调整LLM参数（temperature等）

### 10. 未来改进方向

1. **多轮对话**：支持与用户的多轮交互，澄清需求
2. **学习能力**：从历史执行中学习，优化决策
3. **并行执行**：支持任务并行执行，提高效率
4. **可视化**：提供任务执行的可视化界面
5. **API服务**：提供REST API接口，支持远程调用

## 总结

本智能体架构的核心优势：

1. **智能化**：使用LLM理解用户意图，自动规划任务
2. **鲁棒性**：完善的错误处理和降级机制
3. **可扩展**：模块化设计，易于扩展新功能
4. **用户友好**：自然语言交互，降低使用门槛
5. **状态管理**：完整的任务状态跟踪和历史记录

这使得参考基因组构建从传统的命令行工具升级为真正的智能助手。
